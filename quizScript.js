var levels = {
    level1: [
      {
        "Question": "Use the correct form of the verb do-Are they your friends? What do they __?",
        "Answer": "do"
      },
      {
        "Question": " Write the correct preposition. The news is __  TV",
        "Answer": "on"
      },
      {
        "Question": "Fill in the correct word. She was not well. So she ___ sing yesterday (അതിനാൽ അവൾക്ക് ഇന്നലെ പാടാൻ കഴിഞ്ഞില്ല)",
        "Answers": ["couldn't", "could not"]
      },
      {
        "Question": "Use the correct form of the verb go- Did she ____? (അവൾ പോയോ ?)",
        "Answer": "go"
      },
      {
        "Question": "Fill in the correct possessive pronoun. This is ____ (ഇത് എന്റേതാണ്)",
        "Answer": "mine"
      },
      {
        "Question": "Choose the correct word. These are ____ books (our, ours)",
        "Answer": "our"
      },
      {
        "Question": "Write the complete sentence. How do you say this in English? --മഴയുള്ള ദിവസമാണ്",
        "Answers":["It's a rainy day", "It is a rainy day"]
      },
      {
        "Question": "Fill in the correct WORDS. It’s my book. Can you _______ ? (അതെനിക്കു തരുമോ)",
        "Answer":"give it to me?"
      },
      {
        "Question": "Fill in the correct word. എനിക്ക് പട്ടികളെ ഇഷ്ടമാണ്. I like _____",
        "Answer":"dogs"
      },
      {
        "Question": "Use the correct form of the verb go- അവൻ വെള്ളിയാഴ്ച വീട്ടിൽ പോകാറുണ്ട്. He ___ home on Fridays",
        "Answer":"goes"
      },
      {
        "Question": "Fill in the correct word(s). അവൾക്ക് മത്സ്യം ഇഷ്ടമല്ല. She _____ like fish",
        "Answers":["doesn't", "does not"]
      },
      {
        "Question": "Fill in the correct preposition. I saw the video ___ YouTube",
        "Answer":"on"
      },
      {
        "Question": "Fill in the correct preposition. നീ അവിടെ ആറു മണിക്ക് കാണുമൊ? Will you be there __ 6pm (in/on/at/for)",
        "Answer":"at"
      },
      {
        "Question": "Fill in the correct form of the verb 'to be'. ഇന്നലെ അവൾ വൈകിപ്പോയി. She ____ late yesterday",
        "Answer":"was"
      }
    ],
    level2: [
      {
        "Question": "Fill in the correct word. അവൾ നിനക്ക് പണം വല്ലതും തന്നോ? Did she give you __ money?",
        "Answer": "any"
      },
      {
        "Question": " Use the correct form of the verb clean- ഷെൽഫ് വൃത്തിയാക്കുന്നതിനിടയിൽ ഞാൻ ഗ്ലാസ് പൊട്ടിച്ചു. I broke the glass while __  the shelf",
        "Answer": "cleaning"
      },
      {
        "Question": "Fill in the correct form of the word -good. She is _____ than me.",
        "Answer": "better"
      },
      {
        "Question": "How many pots ____ every week? Use the verb make (അവൾ ആഴ്ചയിൽ എത്ര പാത്രങ്ങൾ ഉണ്ടാക്കാറുണ്ട് ?)",
        "Answer": "does she make"
      },
      {
        "Question": "How do you say this in English?  നിങ്ങൾ എപ്പോഴെങ്കിലും സിംഗപ്പൂരിൽ പോയിട്ടുണ്ടോ?",
        "Answers": ["Have you ever been to Singapore?", "Have you been to Singapore?"]
      },
      {
        "Question": "അവൾ എങ്ങനെ പോയി? How to say this in English?",
        "Answer": "How did she go?"
      },
      {
        "Question": " Fill in the correct form of the verb break- Have you ___ your glasses?",
        "Answer":"broken"
      },
      {
        "Question": "അവൻ എല്ലാ ദിവസവും ഓട്സ് കഴിക്കാറുണ്ട്. How do you say this in English?",
        "Answers":["He eats oats every day", "He eats oats daily"]
      },
      {
        "Question": "Choose the correct word (for, since). She has taken care of her ___ 2010",
        "Answer":"since"
      },
      {
        "Question": "Fill in the appropriate form of the word -bad. This is a bad book. That book is ____ (ആ പുസ്തകം അതിലും മോശമാണ്)",
        "Answers":["worse", "even worse"]
      },
      {
        "Question": "Fill in the correct word(s). What ___ she eat? അവൾ എന്താ തിന്നാറു? ",
        "Answer": "does"
      },
      {
        "Question": "Fill in the correct form of verb go. She has ____ to the market",
        "Answer":"gone"
      },
      {
        "Question": "Fill in the correct article. He is ___ best doctor in this hospital",
        "Answer":"the"
      },
      {
        "Question": "Fill in the correct form of the word old- എനിക്ക് എന്റെ സഹോദരിയേക്കാൾ പ്രായമുണ്ട്. I am ____ than my sister",
        "Answer":"older"
      }
    ],
    level3: [
      {
        "Question": "Write the correct word (can't, could, can't, couldn't). എനിക്ക് ഉറങ്ങാനേ പറ്റിയില്ല. I ___  sleep at all",
        "Answers": ["couldn't", "could not"]
      },
      {
        "Question": "അവൾക്കിപ്പോൾ പരീക്ഷ കഴിഞ്ഞിരിക്കണം. How to say this in English? Use a form of should. She _____ finished the exams by now",
        "Answers": ["should have", "should've"]
      },
      {
        "Question": "Add appropriate Question Tags: She had found a pen,___",
        "Answers": ["hadn't she?", "had she not"]
      },
      {
        "Question": "ഞാൻ എത്തിയപ്പോഴേക്കും അവർ പോയിരുന്നു. They _ when I arrived. (Use a form of leave)",
        "Answer": "had left"
      },
      {
        "Question": "Choose the correct word(s): (is, was, has been, is been).  She __ crying since morning",
        "Answer": "has been"
      },
      {
        "Question": "നിനക്ക് പോകാമായിരുന്നു. How to say this in English?",
        "Answers": ["You could have gone", "You could've gone"]
      },
      {
        "Question": " If I ____ rich, I would buy a big house. Choose the correct form of the verb 'to be'",
        "Answer":"were"
      },
      {
        "Question": "ഞാൻ ദിവസേന വ്യായാമം ചെയ്തിരുന്നു. Fill in the correct word(s) I ___ exercise regularly",
        "Answer":"used to"},
      {
        "Question": "അവൾക്ക് ഇന്നലെ വരാൻ പറ്റിയില്ല. She ___ come yesterday. Choose the right word(s) (will not, should not, may not, could not)",
        "Answers":["could not", "couldn't"]
      },
      {
        "Question": "ഞാൻ അധികം കഴിക്കാൻ പാടില്ലായിരുന്നു? Write the correct option (shouldn't, couldn't, shouldn't have, couldn't have) I ____ eaten too much",
        "Answers": ["shouldn't have", "should not have"]
      },
      {
        "Question": "(Change to Reported Speech) Ali:\"I am tired\"",
        "Answers":["Ali said that he was tired", "Ali said he was tired"]
      },
      {
        "Question": "Choose the correct word(s) (should be cooking, should be cooked, should be cook).ഈ അരി 40-50 മിനിറ്റ് വേവിക്കണം  This rice ___ for 40 to 50 minutes.",
        "Answer":"should be cooked"
      },
      {
        "Question": "How do you say this in English? ഞാൻ എന്റെ കാർ നന്നാക്കിപ്പിച്ചു.",
        "Answers":["I got my car repaired", "I had my car repaired"]
      },
      {
        "Question": "Choose the correct word (make, get, let, have)  I can’t ___ him to wake up early. എനിക്ക് അവനെ നേരത്തെ ഉണർത്താൻ കഴിയില്ല.",
        "Answer":"get"
      }
    ]
};
var state = {
    progress: {
        level1: 0,
        level2: 0,
        level3: 0
    },
    score: {
        level1: new Array(levels.level1.length).fill(0),
        level2: new Array(levels.level2.length).fill(0),
        level3: new Array(levels.level3.length).fill(0)
    }
};
var maxMistakesPerLevel = 3;
var noCourseNeeded = "If you have not guessed the answers, your basics are solid. All you need is some practice. If you want to practice speaking English with me, I offer live sessions over Google meet. Email me for details. My email id is easyenglishwithvini@gmail.com "

function shuffle(array) {
  let currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle.
  while (currentIndex != 0) {

    // Pick a remaining element.
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

// Function to create a question div
function createQuestionDiv(question) {
  var questionDiv = document.createElement('div');
  questionDiv.className = 'question';
  questionDiv.appendChild(document.createTextNode(question));
  return questionDiv;
}

// Function to update question and options
function updateQuestionAndOptions(question, correctAnswer, level, callback) {
    var questionContainer = document.getElementById('questionDiv');
    questionContainer.innerHTML = '';
    questionContainer.appendChild(createQuestionDiv(question));

    document.getElementById('next').onclick = function() {
        var answerContainer = document.getElementById('answer');
        var answer = simplify(answerContainer.value);
        if (correctAnswer instanceof Array) {
            if (correctAnswer.findIndex(a => answer === simplify(a)) !== -1) {
                incrementScore(level);
                displayResult('✅');
            } else {
                displayResult('❌');
            }
        } else if (answer === simplify(correctAnswer)) {
            incrementScore(level);
            displayResult('✅');
        } else {
            displayResult('❌');
        }
        setTimeout(function () {
            if (state.progress[level] < levels[level].length - 1) {
                state.progress[level]++;
                var nextQuestion = levels[level][state.progress[level]];
                answerContainer.value = '';
                clearResult();
                updateQuestionAndOptions(nextQuestion.Question, nextQuestion.Answer || nextQuestion.Answers, level, callback);
            } else {
                if (hasFailedLevel(state.score[level])) {
                    window.location.href = `${level}.html`;
                } else {
                    clearResult();
                    callback();
                }
            }
        }, 1000);
    };
}

function simplify(str) {
    return str.trim().replace(/\s+/g, ' ').replace(/[.?]/g, '').replace(/[‘’]/g, "'").toLowerCase();
}

function incrementScore(level) {
    state.score[level][state.progress[level]] = 1;
}

function displayResult(result) {
    document.getElementById('result').innerHTML = result;
}

function clearResult() {
    document.getElementById('result').innerHTML = '';
}

function hasFailedLevel(level) {
    return level.length - level.reduce((a, b) => a + b) > maxMistakesPerLevel;
}

function startLevel(level, callback) {
    shuffle(levels[level]);
    document.getElementById('answer').value = '';
    updateQuestionAndOptions(levels[level][0].Question, levels[level][0].Answer || levels[level][0].Answers, level, callback);
}

var keyDownListener = function(event) {
    if (document.activeElement.id !== 'answer') {
        document.getElementById('answer').focus();
    }
    if (event.keyCode == 13) {
        if (!document.getElementById('intro').classList.contains('hidden')) {
            document.getElementById('start-quiz').click();
        }
        if (document.getElementById('answer').value !== '') {
            document.getElementById('next').click();
        }
    }
};
document.addEventListener('keydown', keyDownListener);

document.getElementById('start-quiz').addEventListener('click', function(){
    if (!document.getElementById('intro').classList.contains('hidden')) {
        document.getElementById('quiz-container').classList.remove('hidden');
        startLevel('level1', function() {
            startLevel('level2', function() {
                startLevel('level3', function() {
                    var questionContainer = document.getElementById('questionDiv');
                    questionContainer.innerHTML = '';
                    questionContainer.appendChild(createQuestionDiv(noCourseNeeded));
                    document.removeEventListener('keydown', keyDownListener);
                    document.getElementById('answer').classList.add('hidden');
                    document.getElementById('next').classList.add('hidden');
                });
            });
        });
        document.getElementById('intro').classList.add('hidden');
    }
});